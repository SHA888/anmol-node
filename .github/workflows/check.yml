# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Check & Benchmarking

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events
  push:
    branches:
      - 'master'
      - 'ibtida'

  pull_request:
    branches:
      - 'master'
      - 'ibtida'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  checkout:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

  lint:
    needs: checkout

    runs-on: ubuntu-20.04
    container:
      image: anmolnetwork/anmol-node-build:latest
      volumes:
        - ${{ github.workspace }}:/build

    steps:
      - name: Lint Code
        run: cargo fmt -- --check

  test:
    needs: checkout

    runs-on: ubuntu-20.04
    container:
      image: anmolnetwork/anmol-node-build:latest
      volumes:
        - ${{ github.workspace }}:/build

    steps:
      - name: Check
        run: SKIP_WASM_BUILD=1 cargo check --release

      - name: Test
        run: SKIP_WASM_BUILD=1 cargo test --release

  benchmark:
    needs: checkout

    runs-on: ubuntu-20.04
    container:
      image: anmolnetwork/anmol-node-build:latest
      volumes:
        - ${{ github.workspace }}:/build

    steps:
      - name: Check Benchmarks
        run: cargo check --features=runtime-benchmarks --release --manifest-path=node/Cargo.toml
