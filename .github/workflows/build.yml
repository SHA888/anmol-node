name: Build Anmol

on:
  push:
    branches:
    - frevert/feature/docker-images

jobs:
  build-anmol:
    runs-on: ubuntu-18.04
    steps:
    - name: Build 'build' image
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER_NAME }}
        env:
          DOCKER_PW: ${{ secrets.DOCKER_PASSWORD }}
      # checkout repo
      uses: actions/checkout@v2
      run: | 
        # login to dockerhub registry
        docker login --username "$DOCKER_USER" --password "$DOCKER_PASSWORD"
        docker build . -f Dockerfile.build -t anmol-build
        docker tag anmol-build anmolnetwork/anmol-node-build-test:latest
        docker push anmolnetwork/anmol-node-build-test:latest

    - name: Build prod image
      uses: actions/checkout@v2
      with:
        token: ${{ secrets.REPO_ACCESS_TOKEN }}
        env:
          DOCKER_USER: ${{ secrets.DOCKER_USER_NAME }}
        env:
          DOCKER_PW: ${{ secrets.DOCKER_PASSWORD }}
        # event-type: template-updated
        # client-payload: '{"id": "node-template"}'
      run: | 
        # login to dockerhub registry
        docker login --username "$DOCKER_USER" --password "$DOCKER_PASSWORD"
        docker build . -f Dockerfile -t anmol
        docker tag anmol anmolnetwork/anmol-node-test:latest
        docker push anmolnetwork/anmol-node-test:latest
        # next: step to push last image tag to elasticbeanstalk